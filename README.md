# Проект_1 "Удаление автомобиля из видео"

## 1. Тема, описание задачи.
В дипломной работе стоит задача взять фрагмент видео, на котором изображен автомобиль, и удалить этот автомобиль из видео, заменив авто ландшафтом (окружающей средой). 
Первостепенно стоит задача убрать автомобиль из фото, затем из видео. 
Второстепенно (в идеале), хотелось бы заменить автомобиль качественным ландшафтом, чтобы исчезновение авто из видео стало как можно менее заметным.

## [2. База.](https://github.com/alnibl/Portfolio/blob/main/Сбор%2C_анализ_и_парсинг_данных_ipynb"".ipynb)
### Фон.
Общее количество фото фонов для обучения нейронной сети - 2528 изображений.

Из них:

- получены путем парсинга сайта https://oir.mobi – 1420 шт.

![](/images/130.jpg)
- взяты фреймы из видео YouTube – 406 шт.

![](/images/0_38.jpg)
- фото из баз в интернете(частично использованы базы DeepLoc, DeepLocCross, Freiburg Street Crossing, FRIDA ) - 702 шт.

![](/images/Image_79.png)

### Автомобили.
Общее количество фото - 2360 штук.
Фото парсились с сайта http://www.motorpage.ru.
![](/images/16.jpg)

Автомобили были получены путем сегментации, при помощи предобученной нейронной сети для сегментации изображений deeplabv3_resnet101 (библиотека Pytorch).

Авто попиксельно выделялись и отдельно сохранялись в формате PNG, для дальнейшего наложения их на изображения фонов (для получения обучающей выборки).
![](/images/45.png)

## 3. Параметризация данных.

![](/images/seg_1.png)

![](/images/seg_2.png)

Если очень упрощенно описать, то:

X_train для НС это будут фото авто на фоне, а Y_train, это фото фона без автомобилей. 

Нейронная сеть, получая на вход фото авто на фоне, в ходе обучения, в результате back propagation, будет стремиться сделать loss минимальной, а значит изображение на выходе из генератора после обучения сети должно быть максимально похоже на y_train – то есть на картинку фона без автомобиля.
Следовательно, x_train отличается от y_train только тем, что в x_train есть авто, а в y_train его нету. Фон будет идентичным как в x_train, так и в y_train.

### [Пример кода тут.](https://github.com/alnibl/Portfolio/blob/main/"Эксперементы_с_GAN_lodki_ipynb"".ipynb)

## [4. Исследование нейронной сети.](https://github.com/alnibl/Portfolio/blob/main/Копия_блокнота_"GAN_7_ipynb".ipynb)
![](/images/4.png)

### Генератор.
За основу взята сеть U-Net, но с изменениями и дополениями.

Вход (None, 256, 384, 3) - изображение с машиной.

Выход (None, 256, 384, 3) - изображение без машины. Функция tanh (-1…1).

### Дискриминатор.
Урезанная версия генератора(U-Net).

Вход-1 (None, 256, 384, 3) - изображение от генератора (фейк) или реальное.

Вход-2 (None, 256, 384, 3) - изображение условие (фон без машины).

Выход  (None, 256, 384, 1) – карта признаков. Функция sigmoid (0…1).

### VGG19.
Предобученная сеть для получения карт признаков изображений. Не обучалась(заморозил веса), но участвовала в подсчете loss сети.

Вход (None, 256, 384, 3) – изображение от генератора или чистый фон без машины.

Выход (None, 8, 12, 512) – карты признаков.

### Общая ошибка сети строится из:
1) ошибки дискриминатора, который оценивает качество сгенерированного генератором изображения

2) ошибки предобученной сети VGG19 на полученных фичах от Y_train и X_pred

3) ошибки генератора между Y_train и X_pred

### Проблемму нехватки ОЗУ в collab я решил.
Написал функцию image_paste_x_train(), которая формирует X_train прямо во время обучения нейронной сети.

Что происходит в функции image_paste_x_train():

ImageDataGenerator берет картинки авто и фона с colab (или google диска), происходит аугментация по заданным параметрам,
дальше batch_size картинок из генератора преобразовываются из numpy в формат изображений, чтобы дальше производить наложение авто на фон. 
Затем ещё раз меняется размер авто, далее с помощью функции past машина налаживается на фон, координаты наложения авто выбираются случайно (random), 
данные преобразовываются в numpy и передаются в функцию обучения сети – train, сеть обучается в цикле методом train_on_batch.

Для преобразования фона я применил библиотеку Аlbumentations [(https://albumentations.ai/)](https://albumentations.ai/) благодаря которой на фото налаживал эффекты дождя, солнца, тумана, тени, изменял значение RGB картинок, применял размытие к изображениям, применял RandomCrop и Resize.

[Подробный код описывающий работу с нейронной сетью можно посмотреть тут.] (https://github.com/alnibl/Portfolio/blob/main/Копия_блокнота_"GAN_7_ipynb".ipynb)
